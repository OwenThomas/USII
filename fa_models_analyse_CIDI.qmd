---
title: "fa_models"
format: html
embed-resources: true
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r, echo=FALSE}
#| echo: FALSE

library(haven)
library(ggplot2)
library(dplyr)
library(knitr)
depression_2022 <- read_dta("/ess/p2756/data/durable/original-files/Working files/Owen/depression_2022.dta")
#View(depression_2022)

include = c("n_eid","n_29011_0_0", "n_29012_0_0", "n_29013_0_0", "n_29014_0_0", "n_29015_0_0", "n_29016_0_0", "n_29017_0_0", "n_29018_0_0", "n_29019_0_0", "n_29020_0_0", "n_29021_0_0", "n_29022_0_0", "n_29023_0_0", "n_29024_0_0", "n_29025_0_0", "n_29026_0_0", "n_29027_0_0", "n_29028_0_0", "n_29029_0_0", "n_29030_0_0", "n_29031_0_0", "n_29032_0_0", "n_29033_0_0", "n_29034_0_0", "n_29036_0_0")

disinclude = c("n_29002_0_0","n_29003_0_0", "n_29004_0_0", "n_29005_0_0","n_29006_0_0", "n_29007_0_0", "n_29008_0_0", "n_29009_0_0", "n_29010_0_0", "n_29035_0_0", "n_29037_0_0","n_29038_0_0", "n_29038_0_1", "n_29038_0_2", "n_29039_0_0", "n_29039_0_1", "n_29039_0_2", "n_29039_0_3", "n_29039_0_4", "n_29039_0_5", "n_29039_0_6", "n_29040_0_0", "n_29041_0_0", "n_29042_0_0", "n_29043_0_0", "n_29044_0_0", "n_29045_0_0", "n_29046_0_0", "n_29047_0_0", "n_29047_0_1", "n_29048_0_0", "ts_29185_0_0", "ts_29198_0_0"  )

bd_raw <- read.table("/ess/p2756/data/durable/original-files/data-download/ukb675054.tab", header=TRUE, sep="\t")

bd_gender <- bd_raw[,1:2]

remove(bd_raw)

names(bd_gender)[1] <- "eid"

use_depression <- depression_2022[,include]

names(use_depression)[1] <-"eid"

use_depression <- merge(bd_gender, use_depression, by = "eid")

remove_negative_names <- c("n_29011_0_0", "n_29012_0_0", "n_29013_0_0", "n_29014_0_0", "n_29015_0_0", "n_29016_0_0", "n_29017_0_0", "n_29018_0_0", "n_29019_0_0", "n_29020_0_0", "n_29021_0_0", "n_29022_0_0", "n_29026_0_0", "n_29027_0_0", "n_29028_0_0", "n_29029_0_0", "n_29030_0_0", "n_29031_0_0", "n_29032_0_0"  )

for( vn in remove_negative_names){
  i_vn <- which(vn == names(use_depression))
  use_depression[which(use_depression[,i_vn]<0),i_vn] <- NA
}

max_n_depressed_periods <- 7

use_depression[which(use_depression$n_29033_0_0>(max_n_depressed_periods - 1)),]$n_29033_0_0 <- max_n_depressed_periods

use_depression[which(use_depression$n_29033_0_0==-4),]$n_29033_0_0 <- max_n_depressed_periods

use_depression[which(use_depression$n_29033_0_0<0),]$n_29033_0_0 <- NA

use_depression$n_29021_0_0_weightgain <- as.integer((use_depression$n_29021_0_0==0) | (use_depression$n_29021_0_0==2))
use_depression$n_29021_0_0_weightloss <- as.integer((use_depression$n_29021_0_0==1) | (use_depression$n_29021_0_0==2))
use_depression <- use_depression[,-which(names(use_depression)=="n_29021_0_0")]
#how to encode weight changes? field n_29021_0_0

use_depression$n_29020_0_0 <- case_match(use_depression$n_29020_0_0, 0 ~ 2, 1 ~ 3, 2 ~ 1)
use_depression$n_29017_0_0 <- case_match(use_depression$n_29017_0_0, 0 ~ 1, 1 ~ 3, 2 ~ 2)

use_depression[is.na(use_depression$n_29023_0_0),]$n_29023_0_0 <- 0
use_depression[is.na(use_depression$n_29024_0_0),]$n_29024_0_0 <- 0
use_depression[is.na(use_depression$n_29025_0_0),]$n_29025_0_0 <- 0

hist(colSums(!is.na(use_depression[5:28])))

ud_cc <- use_depression[complete.cases(use_depression),]
ud_cc[,apply(ud_cc, 2, min)==0] <- ud_cc[,apply(ud_cc, 2, min)==0] + 1
ud_cc <- ud_cc[,names(ud_cc)[c(1,2,25,26,seq(3,24),27,28)]]

#ud_cc <- ud_cc[,-which(names(ud_cc)=="n_29022_0_0")]

ud_men <- ud_cc[ud_cc[,2]==2,]
ud_men <- ud_men[,-c(1,2)]

ud_women <- ud_cc[ud_cc[,2]==1,]
ud_women <- ud_women[,-c(1,2)]

ud_all <- ud_cc[,-c(1,2)]

ud_men$n_29034_0_0 <- scale(ud_men$n_29034_0_0)
ud_men$n_29036_0_0 <- scale(ud_men$n_29036_0_0)

ud_women$n_29034_0_0 <- scale(ud_women$n_29034_0_0)
ud_women$n_29036_0_0 <- scale(ud_women$n_29036_0_0)

ud_all$n_29034_0_0 <- scale(ud_all$n_29034_0_0)
ud_all$n_29036_0_0 <- scale(ud_all$n_29036_0_0)

library(psych)

G_max <- 10
G_seq <- seq(G_max)

bigcolumnnames <- c("Age at first episode of depression", "Age at last episode of depression", "Ever had prolonged feelings of sadness or depression", "Ever had prolonged loss of interest in normal activities", "Depression possibly related to stressful or traumatic event", "Fraction of day affected during worst episode of depression", "Frequency of depressed days during worst episode of depression", "Brightening of mood in response to positive events during worst episode of depression", "Time of day that mood was worse during worst episode of depression", "Feelings of tiredness during worst episode of depression", "Feelings of heaviness in limbs during worst episode of depression", "Change in appetite during worst episode of depression", "Sleep changed during sadness/depression or loss of interest", "Trouble falling asleep", "Waking too early", "Sleeping too much", "Difficulty concentrating during worst depression", "Feelings of worthlessness during worst period of depression", "Feelings of guilt during worst period of depression", "Thoughts of death during worst depression", "Duration of worst depression", "Impact on normal roles during worst period of depression", "Difficult coping with rejection or negative responses", "Lifetime number of depressed periods", "Weight gain during worst period of depression", "Weight loss during worst period of depression")


```

```{r}
#| echo: FALSE

print_max_factors <- function(fa.model, columnnames, G_model){

    for(j in seq(G_model)){
      print(paste(j, " of ", G_model))
      maxcolumnnames_j <- columnnames[max.col(abs(fa.model$weights))==j]
      maxcolumnsigns_j <- sign(fa.model$weights[,j])[max.col(abs(fa.model$weights))==j]
      maxcolumnvalues_j <- fa.model$weights[,j][max.col(abs(fa.model$weights))==j]

     # print(maxcolumnnames_j)
    #  print(maxcolumnsigns_j)
      
      print(t(rbind(maxcolumnnames_j, t(maxcolumnsigns_j), t(signif(maxcolumnvalues_j,4)))))
    }
    
}

plot_BIC_from_fa <- function(model, G_min, G_max){
  vec.BIC <- vector()
  for(i in seq(G_min,G_max)){
    vec.BIC <- append(vec.BIC,model[[i]]$BIC)
  }
  
  plot(seq(G_min,G_max),vec.BIC)
  plot(seq(G_min,G_max - 1),diff(vec.BIC,differences = 1))
  plot(seq(G_min,G_max - 2),diff(vec.BIC,differences = 2))
  
}

plot_BIC_from_fa_list <- function(model_list, G_min, G_max){
  plot.data <- data.frame(metric = double(), G = integer(), method = character())
  method_names = c("mixed", "pearson", "kendall", "spearman")
  n <- length(model_list)
  for(j in seq(n)){
      vec.BIC <- vector()
  for(i in seq(G_min,G_max)){
    vec.BIC <- append(vec.BIC,model[[i]]$BIC)
  }
      
  plot.data <- rbind(plot.data, data.frame(vec.BIC, seq(G_min, G_max), rep(method_names[[j]], G_max-G_min)))
  
  }
  
  plot(seq(G_min,G_max),vec.BIC)
  plot(seq(G_min,G_max - 1),diff(vec.BIC,differences = 1))
  plot(seq(G_min,G_max - 2),diff(vec.BIC,differences = 2))
  
}

```

You can add options to executable code like this

```{r}
#| echo: FALSE

mixed.cor.all <- readRDS(file = paste("./2022_fitted_models_v3/mixed.cor.all.rds",sep=""))

pearson.cor.all <- readRDS(file = paste("./2022_fitted_models_v3/pearson.cor.all.rds",sep=""))

kendall.cor.all <- readRDS(file = paste("./2022_fitted_models_v3/kendall.cor.all.rds",sep=""))

spearman.cor.all <- readRDS(file = paste("./2022_fitted_models_v3/spearman.cor.all.rds",sep=""))

heatmap(mixed.cor.all, Rowv = NA, Colv = NA)

heatmap(pearson.cor.all, Rowv = NA, Colv = NA)

heatmap(kendall.cor.all, Rowv = NA, Colv = NA)

heatmap(spearman.cor.all, Rowv = NA, Colv = NA)


```

The `echo: false` option disables the printing of code (only output is displayed).

```{r}
#| echo: FALSE

all.mixed.list <- readRDS(file = "./2022_fitted_models_v3/m.fa.all.2022.mixed.list.rds")
all.pearson.list <- readRDS(file = "./2022_fitted_models_v3/m.fa.all.2022.pearson.list.rds")
all.kendall.list <- readRDS(file = "./2022_fitted_models_v3/m.fa.all.2022.kendall.list.rds")
all.spearman.list <- readRDS(file = "./2022_fitted_models_v3/m.fa.all.2022.spearman.list.rds")

```

```{r}
#| echo: FALSE

list.all.lists <- list(all.mixed.list, all.pearson.list, all.kendall.list, all.spearman.list)

list.all.cors <- list(mixed.cor.all, pearson.cor.all, kendall.cor.all, spearman.cor.all)

```

```{r}
#| echo: FALSE

plot_metrics_comparison_from_fa <- function(list.of.lists,G_max,metric_name,pop_name, log.metric=TRUE){

  plot.data <- data.frame(metric = double(), G = integer(), method = character())
  method_names = c("mixed", "pearson", "kendall", "spearman")

  for(j in seq(4)){
      vec.metric <- vector()
  for(i in seq(G_max)){
    if(metric_name=="RMSEA"){
      vec.entry <- list.of.lists[[j]][[i]][[metric_name]][1]
    } else if(metric_name=="CFI"){
      vec.entry <- 1 - max(0,list.of.lists[[j]][[i]][[metric_name]])
    } else {
      vec.entry <- list.of.lists[[j]][[i]][[metric_name]]
    }
    
    if (is.null(vec.entry)){
      vec.metric <- append(vec.metric, NA)
    }else{
      vec.metric <- append(vec.metric, vec.entry)
    }
    
  }
  plot.data <- rbind(plot.data, data.frame(metric = vec.metric, G = seq(G_max), method = rep(method_names[[j]], G_max)))
  
  }

    plot_title <- paste(metric_name,"for",pop_name,sep=" ")
    if(log.metric){
      plot_title <- paste("log scale",plot_title, sep= " ")
    }
    ggplot(plot.data, aes(x = G, y = metric)) +
    geom_point(aes(colour = method)) +
    theme_minimal() +
    ggtitle(plot_title) + 
    labs(x = "K") + 
    scale_x_continuous(breaks = seq(10)) +
    {if(log.metric)scale_y_continuous(transform = "log10")}
  
}
```

```{r}
#| echo: FALSE

method_names = c("mixed", "pearson", "kendall", "spearman")
metric_names = c("RMSEA", "rms", "BIC", "EBIC", "CFI")
metric_names = c("STATISTIC", "RMSEA", "rms", "BIC", "EBIC", "CFI")
pop_names = c("all")
#pop_names = c("all")

G_max <- 10
for(metric_name in metric_names){
    print(plot_metrics_comparison_from_fa(list.all.lists,G_max,metric_name, "all", log.metric=FALSE))
    print(plot_metrics_comparison_from_fa(list.all.lists,G_max,metric_name, "all", log.metric=TRUE))
}

```

```{r}
#| echo: FALSE

for(j in seq(4)){
  scree(list.all.cors[[j]])
}

```

```{r}
#| echo: FALSE
#| eval: FALSE

  for(j in seq(4)){
    for(G_here in seq(G_max)){
      print(method_names[j])
      print_max_factors(list.all.lists[[j]][[G_here]],bigcolumnnames,G_here)
    }
  }

```

```{r}
#| echo: FALSE
#| output: asis

get_max_factors <- function(fa.model, columnnames, G_model, method_name){
  
    assignment <- data.frame(variables=columnnames,assignment=max.col(abs(fa.model$weights)), method_name=method_name)
    return(assignment)
}

match_max_factors <- function(list_max_factor, G_max){
  resultstable <- data.frame(variables = list_max_factor[[1]]$variables)
  for (j in seq(G_max)){
    resultstable[,as.character(j)] <- ""
  }
  
  for(mfa in list_max_factor){
    for(j in seq(dim(mfa)[1])){
      resultstable[j,mfa[j,]$assignment+1] <- paste(resultstable[j,mfa[j,]$assignment + 1], mfa[j,]$method_name,sep="")
    }
  }
  
  return(resultstable)
}
method_codes <- c("M", "P", "K", "S")
i<-3
for (G_here in seq(5)){
  list_max_factors <- list()
for(j in seq(4)){
  list_max_factors[[j]] <- get_max_factors(list.all.lists[[j]][[G_here]],bigcolumnnames,G_here, method_codes[j])
}

resultstable <- match_max_factors(list_max_factors, G_here)
print(kable(resultstable))
}


```
